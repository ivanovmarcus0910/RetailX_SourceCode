@{
    Layout = "_FinanceLayout";
}
@model IEnumerable<BusinessObject.Models.ReportRevenue>
@{
    ViewData["Title"] = "Báo Cáo Tài Chính";
    DateTime startDate = DateTime.Parse(ViewBag.StartDate);
    DateTime endDate = DateTime.Parse(ViewBag.EndDate);
    int currentPage = ViewBag.CurrentPage;
    int totalPages = ViewBag.TotalPages;
    int totalReports = ViewBag.TotalReports;
    var allReports = (List<BusinessObject.Models.ReportRevenue>)ViewBag.AllReports;

    var totalRevenue = allReports?.Sum(r => r.AmountRevenue ?? 0) ?? 0;
    var totalCost = allReports?.Sum(r => r.AmountCost ?? 0) ?? 0;
    var totalSalary = allReports?.Sum(r => r.AmountSalary ?? 0) ?? 0;
    var totalProfit = allReports?.Sum(r => r.Profit ?? 0) ?? 0;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .summary-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }

    .quick-filter-btn {
        transition: all 0.2s;
    }

        .quick-filter-btn:hover {
            transform: scale(1.05);
        }
</style>

<!-- HEADER INFO -->
<div class="mb-3">
    <p class="text-muted mb-0" style="font-size: 0.9rem;">
        <i class="far fa-calendar-alt me-1"></i>
        Từ <strong>@startDate.ToString("dd/MM/yyyy")</strong> đến <strong>@endDate.ToString("dd/MM/yyyy")</strong>
        <span class="badge bg-secondary ms-2" style="font-size: 0.75rem;">@totalReports báo cáo</span>
    </p>
</div>

<!-- THÔNG BÁO -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- SUMMARY CARDS -->
@if (allReports != null && allReports.Any())
{
    <div class="row g-2 mb-3">
        <!-- Card 1: Doanh Thu -->
        <div class="col-md-3">
            <div class="card summary-card border-0 shadow-sm h-100" style="border-left-color: #0d6efd !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">Tổng Doanh Thu</p>
                            <h5 class="mb-0 text-primary fw-bold" style="font-size: 1.1rem;">@totalRevenue.ToString("N0")</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">VNĐ</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                            <i class="fas fa-dollar-sign text-primary" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: Chi Phí Nhập -->
        <div class="col-md-3">
            <div class="card summary-card border-0 shadow-sm h-100" style="border-left-color: #dc3545 !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">Chi Phí Nhập Hàng</p>
                            <h5 class="mb-0 text-danger fw-bold" style="font-size: 1.1rem;">@totalCost.ToString("N0")</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">VNĐ</small>
                        </div>
                        <div class="bg-danger bg-opacity-10 p-2 rounded">
                            <i class="fas fa-shopping-cart text-danger" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 3: Chi Phí Lương -->
        <div class="col-md-3">
            <div class="card summary-card border-0 shadow-sm h-100" style="border-left-color: #fd7e14 !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">Chi Phí Lương</p>
                            <h5 class="mb-0 text-warning fw-bold" style="font-size: 1.1rem;">@totalSalary.ToString("N0")</h5>
                            <small class="text-muted" style="font-size: 0.7rem;">VNĐ</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-2 rounded">
                            <i class="fas fa-users text-warning" style="font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 4: Lợi Nhuận -->
        <div class="col-md-3">
            <div class="card summary-card border-0 shadow-sm h-100" style="border-left-color: @(totalProfit >= 0 ? "#198754" : "#dc3545") !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">Lợi Nhuận Ròng</p>
                            <h5 class="mb-0 fw-bold" style="color: @(totalProfit >= 0 ? "#198754" : "#dc3545"); font-size: 1.1rem;">
                                @totalProfit.ToString("N0")
                            </h5>
                            <small class="text-muted" style="font-size: 0.7rem;">VNĐ</small>
                        </div>
                        <div class="p-2 rounded" style="background-color: @(totalProfit >= 0 ? "rgba(25, 135, 84, 0.1)" : "rgba(220, 53, 69, 0.1)")">
                            <i class="fas @(totalProfit >= 0 ? "fa-arrow-trend-up" : "fa-arrow-trend-down")"
                               style="color: @(totalProfit >= 0 ? "#198754" : "#dc3545"); font-size: 1.3rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- TOOLBAR -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-2 px-3">
        <form asp-action="Index" method="get" id="filterForm">
            <input type="hidden" name="page" value="1" />
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label mb-1" style="font-size: 0.85rem;">
                        <i class="far fa-calendar me-1"></i> Từ ngày
                    </label>
                    <input type="date"
                           name="startDateStr"
                           id="startDateInput"
                           value="@startDate.ToString("yyyy-MM-dd")"
                           class="form-control form-control-sm"
                           required />
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-1" style="font-size: 0.85rem;">
                        <i class="far fa-calendar me-1"></i> Đến ngày
                    </label>
                    <input type="date"
                           name="endDateStr"
                           id="endDateInput"
                           value="@endDate.ToString("yyyy-MM-dd")"
                           class="form-control form-control-sm"
                           required />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-filter me-1"></i> Lọc
                    </button>
                </div>
                <div class="col-md-2">
                    <a asp-action="Chart"
                       asp-route-startDateStr="@startDate.ToString("yyyy-MM-dd")"
                       asp-route-endDateStr="@endDate.ToString("yyyy-MM-dd")"
                       class="btn btn-info btn-sm w-100 text-white">
                        <i class="fas fa-chart-line me-1"></i> Xem Biểu Đồ
                    </a>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="resetToday()">
                        <i class="fas fa-rotate me-1"></i> Hôm nay
                    </button>
                </div>
            </div>

            <!-- Quick Filters -->
            <div class="d-flex gap-1 mt-2 flex-wrap">
                <span class="text-muted align-self-center me-1" style="font-size: 0.8rem;">
                    <i class="fas fa-bolt me-1"></i> Nhanh:
                </span>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-filter-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="setDateRange(0)">
                    Hôm nay
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-filter-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="setDateRange(7)">
                    7 ngày
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-filter-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="setDateRange(30)">
                    30 ngày
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-filter-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="setThisMonth()">
                    Tháng này
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-filter-btn" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="setLastMonth()">
                    Tháng trước
                </button>
            </div>
        </form>

        <!-- Action Buttons -->
        <div class="border-top mt-2 pt-2">
            <div class="row g-2">
                <div class="col-md-4">
                    <button type="button"
                            class="btn btn-success btn-sm w-100"
                            onclick="generateReport()"
                            id="btnGenerate">
                        <i class="fas fa-file-invoice-dollar me-1"></i> Tạo Báo Cáo Mới
                    </button>
                </div>
                <div class="col-md-4">
                    <a asp-action="ExportSales"
                       asp-route-startDateStr="@startDate.ToString("yyyy-MM-dd")"
                       asp-route-endDateStr="@endDate.ToString("yyyy-MM-dd")"
                       class="btn btn-outline-primary btn-sm w-100"
                       id="exportSalesLink">
                        <i class="fas fa-file-csv me-1"></i> Xuất DL Bán Hàng
                    </a>
                </div>
                <div class="col-md-4">
                    <a asp-action="ExportReportSummary"
                       asp-route-startDateStr="@startDate.ToString("yyyy-MM-dd")"
                       asp-route-endDateStr="@endDate.ToString("yyyy-MM-dd")"
                       class="btn btn-outline-success btn-sm w-100"
                       id="exportSummaryLink">
                        <i class="fas fa-file-excel me-1"></i> Xuất BC Tổng Hợp
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TABLE -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">
                <i class="fas fa-list me-2"></i>
                Lịch Sử Báo Cáo
                @if (totalReports > 0)
                {
                    <span class="badge bg-primary" style="font-size: 0.7rem;">@totalReports</span>
                }
            </h6>
            @if (totalReports > 0)
            {
                <span class="text-muted" style="font-size: 0.8rem;">
                    Trang @currentPage / @totalPages
                </span>
            }
        </div>
    </div>
    <div class="card-body p-0">
        @if (Model == null || !Model.Any())
        {
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                    Chưa có báo cáo nào trong kỳ <strong>@startDate.ToString("dd/MM/yyyy")</strong> đến <strong>@endDate.ToString("dd/MM/yyyy")</strong>
                </p>
                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="generateReport()">
                    <i class="fas fa-plus me-1"></i> Tạo Báo Cáo Đầu Tiên
                </button>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3" style="width: 60px;">ID</th>
                            <th style="width: 180px;">Kỳ Báo Cáo</th>
                            <th class="text-end" style="width: 120px;">Doanh Thu</th>
                            <th class="text-end" style="width: 110px;">CP Nhập</th>
                            <th class="text-end" style="width: 110px;">CP Lương</th>
                            <th class="text-end" style="width: 120px;">Lợi Nhuận</th>
                            <th style="width: 130px;">Ngày Tạo</th>
                            <th class="pe-3" style="width: 140px;">Người Tạo</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int displayIndex = (currentPage - 1) * 10 + 1;
                        }

                        @foreach (var item in Model)
                        {
                            <tr>
                                <td class="ps-3">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">#@displayIndex</span>
                                </td>
                                <td>
                                    <i class="far fa-calendar-alt text-muted me-1" style="font-size: 0.8rem;"></i>
                                    <small>@item.DayStart - @item.DayEnd</small>
                                </td>
                                <td class="text-end">
                                    <span class="text-primary fw-semibold">@item.AmountRevenue?.ToString("N0")</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-danger">@item.AmountCost?.ToString("N0")</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-warning">@item.AmountSalary?.ToString("N0")</span>
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold @(item.Profit >= 0 ? "text-success" : "text-danger")">
                                        <i class="fas fa-arrow-@(item.Profit >= 0 ? "up" : "down")" style="font-size: 0.7rem;"></i>
                                        @item.Profit?.ToString("N0")
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">@item.CreateDate?.ToString("dd/MM/yyyy HH:mm")</small>
                                </td>
                                <td class="pe-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-1 me-2">
                                            <i class="fas fa-user text-primary" style="font-size: 0.7rem;"></i>
                                        </div>
                                        <small>@(item.Staff?.StaffName ?? "N/A")</small>
                                    </div>
                                </td>
                            </tr>
                            displayIndex++;
                        }
                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            @if (totalPages > 1)
            {
                <div class="card-footer bg-white border-top py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted" style="font-size: 0.8rem;">
                            <strong>@((currentPage - 1) * 10 + 1)</strong> - <strong>@Math.Min(currentPage * 10, totalReports)</strong> / <strong>@totalReports</strong>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { startDateStr = startDate.ToString("yyyy-MM-dd"), endDateStr = endDate.ToString("yyyy-MM-dd"), page = 1 })">
                                        <i class="fas fa-angles-left"></i>
                                    </a>
                                </li>
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { startDateStr = startDate.ToString("yyyy-MM-dd"), endDateStr = endDate.ToString("yyyy-MM-dd"), page = currentPage - 1 })">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>

                                @{
                                    int startPage = Math.Max(1, currentPage - 2);
                                    int endPage = Math.Min(totalPages, currentPage + 2);
                                }

                                @for (int i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(i == currentPage ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("Index", new { startDateStr = startDate.ToString("yyyy-MM-dd"), endDateStr = endDate.ToString("yyyy-MM-dd"), page = i })">@i</a>
                                    </li>
                                }

                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { startDateStr = startDate.ToString("yyyy-MM-dd"), endDateStr = endDate.ToString("yyyy-MM-dd"), page = currentPage + 1 })">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { startDateStr = startDate.ToString("yyyy-MM-dd"), endDateStr = endDate.ToString("yyyy-MM-dd"), page = totalPages })">
                                        <i class="fas fa-angles-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            }
        }
    </div>
</div>

<script>
    function setDateRange(days) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        document.getElementById('startDateInput').value = formatDate(startDate);
        document.getElementById('endDateInput').value = formatDate(endDate);
        document.getElementById('filterForm').submit();
    }

    function setThisMonth() {
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        document.getElementById('startDateInput').value = formatDate(startDate);
        document.getElementById('endDateInput').value = formatDate(endDate);
        document.getElementById('filterForm').submit();
    }

    function setLastMonth() {
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const endDate = new Date(now.getFullYear(), now.getMonth(), 0);

        document.getElementById('startDateInput').value = formatDate(startDate);
        document.getElementById('endDateInput').value = formatDate(endDate);
        document.getElementById('filterForm').submit();
    }

    function resetToday() {
        const today = new Date();
        document.getElementById('startDateInput').value = formatDate(today);
        document.getElementById('endDateInput').value = formatDate(today);
        document.getElementById('filterForm').submit();
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function generateReport() {
        const startDate = document.getElementById('startDateInput').value;
        const endDate = document.getElementById('endDateInput').value;

        if (!startDate || !endDate) {
            alert('Vui lòng chọn khoảng thời gian!');
            return;
        }

        const btn = document.getElementById('btnGenerate');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang tạo...';

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '@Url.Action("Generate", "Report")';

        ['startDate', 'endDate'].forEach(name => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = name === 'startDate' ? startDate : endDate;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }

    document.getElementById('startDateInput').addEventListener('change', updateExportLinks);
    document.getElementById('endDateInput').addEventListener('change', updateExportLinks);

    function updateExportLinks() {
        const startDate = document.getElementById('startDateInput').value;
        const endDate = document.getElementById('endDateInput').value;

        ['exportSalesLink', 'exportSummaryLink'].forEach(id => {
            const link = document.getElementById(id);
            if (link) {
                const url = new URL(link.href);
                url.searchParams.set('startDateStr', startDate);
                url.searchParams.set('endDateStr', endDate);
                link.href = url.toString();
            }
        });
    }
</script>