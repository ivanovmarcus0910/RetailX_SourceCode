@model List<dynamic>
@{
    ViewData["Title"] = "📦 Import Report";
}

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <p class="text-muted mb-0">Thống kê chi tiết hàng hóa nhập theo thời gian.</p>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0 fw-bold text-primary"><i class="bi bi-funnel"></i> Bộ lọc tìm kiếm</h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="ImportReport">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label fw-semibold small text-secondary">Năm</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-event"></i></span>
                            <select name="year" class="form-select border-start-0 ps-0" asp-items="ViewBag.Years">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold small text-secondary">Tháng</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-month"></i></span>
                            <select name="month" class="form-select border-start-0 ps-0" asp-items="ViewBag.Months">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-secondary">Nhà cung cấp</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-truck"></i></span>
                            <select name="supplierId" class="form-select border-start-0 ps-0" asp-items="ViewBag.Suppliers">
                                <option value="">Tất cả nhà cung cấp</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold small text-secondary">Danh mục</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-tags"></i></span>
                            <select name="categoryId" class="form-select border-start-0 ps-0" asp-items="ViewBag.Categories">
                                <option value="">Tất cả danh mục</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 fw-bold">
                            <i class="bi bi-search me-1"></i> Lọc dữ liệu
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @{
        var qYear = ViewContext.HttpContext.Request.Query["year"].FirstOrDefault();
        var qMonth = ViewContext.HttpContext.Request.Query["month"].FirstOrDefault();
        var qSupplier = ViewContext.HttpContext.Request.Query["supplierId"].FirstOrDefault();
        var qCategory = ViewContext.HttpContext.Request.Query["categoryId"].FirstOrDefault();
    }

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 fw-bold"><i class="bi bi-table"></i> Kết quả báo cáo</h5>
            <a class="btn btn-success btn-sm fw-bold"
               href="@Url.Action("ExportImportReport", "InventoryDashboard",
                     new { year = qYear, month = qMonth, supplierId = qSupplier, categoryId = qCategory })">
                <i class="bi bi-file-earmark-excel me-1"></i> Export CSV
            </a>
        </div>
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-muted">Không tìm thấy dữ liệu phù hợp</h5>
                    <p class="text-secondary small">Vui lòng thử lại với bộ lọc khác.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary">
                            <tr>
                                <th class="py-3 ps-4 border-bottom-0">Ngày nhập</th>
                                <th class="py-3 border-bottom-0">Tên sản phẩm</th>
                                <th class="py-3 text-end border-bottom-0">Số lượng</th>
                                <th class="py-3 text-end border-bottom-0">Đơn giá</th>
                                <th class="py-3 text-end pe-4 border-bottom-0">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach (var group in Model
                                    .GroupBy(m => new
                                    {
                                        Year = m.Year,
                                        Month = int.Parse(m.TimeGroup.Replace("Tháng ", "")),
                                        TimeGroup = m.TimeGroup
                                    })
                                    .OrderByDescending(g => g.Key.Year)
                                    .ThenByDescending(g => g.Key.Month))
                            {
                                var totalGroup = group.Sum(x => (decimal)x.Total);

                                <tr class="table-group-divider bg-light">
                                    <td colspan="5" class="ps-4 py-2 text-primary fw-bold small text-uppercase">
                                        <i class="bi bi-calendar3 me-1"></i> @group.Key.TimeGroup - @group.Key.Year
                                    </td>
                                </tr>

                                foreach (var item in group)
                                {
                                    <tr>
                                        <td class="ps-4 text-muted">@Convert.ToDateTime(item.CreateDate).ToString("dd/MM/yyyy")</td>
                                        <td class="fw-medium">@item.ProductName</td>
                                        <td class="text-end">
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill px-3">
                                                @item.Quantity
                                            </span>
                                        </td>
                                        <td class="text-end text-muted">@String.Format("{0:N0}", item.Price) ₫</td>
                                        <td class="text-end pe-4 fw-bold text-dark">@String.Format("{0:N0}", item.Total) ₫</td>
                                    </tr>
                                }

                                <tr class="bg-primary bg-opacity-10">
                                    <td colspan="4" class="text-end py-3">
                                        <span class="text-primary fw-bold">Tổng @group.Key.TimeGroup - @group.Key.Year:</span>
                                    </td>
                                    <td class="text-end pe-4 py-3">
                                        <span class="text-primary fw-bolder fs-6">@String.Format("{0:N0}", totalGroup) ₫</span>
                                    </td>
                                </tr>
                            }

                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<style>
    /* CSS nhỏ để làm đẹp thêm các input group */
    .input-group-text {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    .form-select:focus, .btn-primary:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    .table-group-divider {
        border-top: 2px solid #e9ecef;
    }
</style>