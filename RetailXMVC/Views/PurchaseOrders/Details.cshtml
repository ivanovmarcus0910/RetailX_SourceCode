@model BusinessObject.Models.PurchaseOrder
@{
    var details = ViewBag.Details as List<BusinessObject.Models.PurchaseOrderDetail>;
}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="mb-1">PO #@Model.PurchaseOrderId</h2>
        <div class="text-muted">
            <span><strong>Supplier:</strong> @Model.Supplier?.SupplierName</span> |
            <span><strong>Date:</strong> @Model.CreateDate.ToShortDateString()</span> |
            <span><strong>Status:</strong> @(Model.Status == 2 ? "Pending" : Model.Status == 3 ? "Confirmed" : "Unknown")</span>
        </div>
    </div>
    <div class="d-flex gap-2">
        @if (Model.Status != 3)
        {
            <form asp-action="Approve" method="post" class="m-0">
                <input type="hidden" name="id" value="@Model.PurchaseOrderId" />
                <button class="btn btn-success">Confirm</button>
            </form>
        }
        <a asp-controller="PurchaseOrders" asp-action="Index" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<hr />

<!-- Order Items -->
<h3 class="mb-2">Order Items</h3>

@if (Model.Status != 3)
{
    <button class="btn btn-create mb-2" id="btnAddProduct">Add Product</button>
}

<!-- Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="productModalContent"></div>
    </div>
</div>

<!-- Table -->
<table class="table mt-3 table-hover">
    <thead>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="poDetailsBody">
        @foreach (var d in details)
        {
            <tr data-detail-id="@d.PurchaseOrderDetailId">
                <td>@d.Product?.ProductName</td>
                <td>@(d.Quantity ?? 0)</td>
                <td>@(d.Price ?? 0)</td>
                <td>@((d.Quantity ?? 0) * (d.Price ?? 0))</td>
                <td>
                    @if (Model.Status != 3)
                    {
                        <button class="btn btn-info btn-sm btn-edit" data-id="@d.PurchaseOrderDetailId">Edit</button>
                        <button class="btn btn-danger btn-sm btn-delete" data-id="@d.PurchaseOrderDetailId">Delete</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<style>
/* Header & buttons */
.btn-create { background-color: #3C5EC0; color: white; border-radius: 8px; padding: 6px 14px; }
.btn-create:hover { background-color: #2A4A99; }

.btn-info { background-color: #17A2B8; color: white; border-radius: 6px; padding: 4px 10px; }
.btn-info:hover { background-color: #138496; }

.btn-danger { background-color: #E03131; color: white; border-radius: 6px; padding: 4px 10px; }
.btn-danger:hover { background-color: #C92A2A; }

.btn-success { background-color: #37B24D; color: white; border-radius: 6px; padding: 6px 14px; }
.btn-success:hover { background-color: #2F9E44; }

.btn-secondary { background-color: #868E96; color: white; border-radius: 6px; padding: 6px 14px; }
.btn-secondary:hover { background-color: #6C757D; }

.table-hover tbody tr:hover { background-color: #f1f1f1; }
</style>

@section Scripts {
<script>
$(document).ready(function(){

    // --- Open Add Product Modal ---
    $(document).on("click", "#btnAddProduct", function(){
        $.get('@Url.Action("Create","PurchaseOrderDetail")', 
            { orderId: @Model.PurchaseOrderId, supplierId: @Model.SupplierId },
            function(data){
                $("#productModalContent").html(data);
                $("#productModal").modal("show");
            }
        );
    });

    // --- Open Edit Product Modal ---
    $(document).on("click", ".btn-edit", function(){
        var id = $(this).data("id");
        $.get('@Url.Action("Edit","PurchaseOrderDetail")', { detailId: id }, function(data){
            $("#productModalContent").html(data);
            $("#productModal").modal("show");
        });
    });

    // --- Open Delete Modal ---
    $(document).on("click", ".btn-delete", function(){
        var id = $(this).data("id");
        $.get('@Url.Action("Delete","PurchaseOrderDetail")', { detailId: id, orderId: @Model.PurchaseOrderId }, function(data){
            $("#productModalContent").html(data);
            $("#productModal").modal("show");
        });
    });

    // --- Submit Add Product ---
    $(document).on("submit", "#addProductForm", function(e){
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: "POST",
            url: form.attr("action"),
            data: form.serialize(),
            success: function(res){
                if(res.success){
                    $("#productModal").modal("hide");
                    location.reload();
                } else {
                    $("#productModalContent").html(res); // show errors
                }
            }
        });
    });

    // --- Submit Edit Product ---
    $(document).on("submit", "#productForm", function(e){ // Edit form id
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: "POST",
            url: form.attr("action"),
            data: form.serialize(),
            success: function(res){
                if(res.success){
                    $("#productModal").modal("hide");
                    location.reload();
                } else {
                    $("#productModalContent").html(res);
                }
            }
        });
    });

    // --- Submit Delete ---
    $(document).on("submit", "#deleteForm", function(e){
        e.preventDefault();
        var form = $(this);
        $.ajax({
            type: "POST",
            url: form.attr("action"),
            data: form.serialize(),
            success: function(res){
                if(res.success){
                    $("#productModal").modal("hide");
                    location.reload();
                }
            }
        });
    });

});
</script>
}
